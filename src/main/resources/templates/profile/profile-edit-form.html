<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원정보 수정</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .profile-image-section {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background-color: #fafafa;
        }
        .current-profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid #007aff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .default-profile {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        .file-input-label {
            background: #007aff;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            transition: background 0.2s;
        }
        .file-input-label:hover {
            background: #0056b3;
        }
        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
        .image-preview {
            margin-top: 15px;
        }
        .preview-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #007aff;
        }
        .btn {
            background: #007aff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .readonly-input {
            background-color: #f8f9fa;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h1>회원정보 수정</h1>

    <form id="profile">
        <!-- 현재 프로필 이미지 표시 -->
        <div class="profile-image-section">
            <div th:if="${userDetailsDto.user.mbProfileUrl != null and !userDetailsDto.user.mbProfileUrl.isEmpty()}">
                <img th:src="${userDetailsDto.user.mbProfileUrl}"
                     alt="현재 프로필 사진"
                     class="current-profile-image"
                     id="currentProfileImage">
                <p>현재 프로필 사진</p>
            </div>
            <div th:unless="${userDetailsDto.user.mbProfileUrl != null and !userDetailsDto.user.mbProfileUrl.isEmpty()}">
                <div class="default-profile" id="defaultProfile">
                    <span th:text="${userDetailsDto.user.mbNickname?.substring(0,1)?.toUpperCase()}">U</span>
                </div>
                <p>기본 프로필</p>
            </div>

            <div class="file-input-wrapper">
                <label for="files" class="file-input-label">새 프로필 사진 선택</label>
                <input type="file" id="files" name="files" class="file-input" accept="image/*" />
            </div>
            <div class="file-info">
                <small>※ 이미지 파일만 업로드 가능 (최대 5MB)</small>
            </div>

            <!-- 새 이미지 미리보기 -->
            <div id="imagePreview" class="image-preview" style="display: none;">
                <p>새 프로필 사진 미리보기:</p>
                <img id="previewImage" class="preview-image" alt="미리보기">
            </div>
        </div>

        <div class="form-group">
            <label for="authUserId">로그인 아이디</label>
            <input type="text" id="authUserId" name="authUserId" class="readonly-input"
                   th:value="${userDetailsDto.userAuth.authUserId}" readonly />
        </div>

        <div class="form-group">
            <label for="priEmail">이메일</label>
            <input type="email" id="priEmail" name="priEmail"
                   th:value="${userDetailsDto.userPrivate.priEmail}" />
        </div>

        <div class="form-group">
            <label for="priBirth">생년월일</label>
            <input type="date" id="priBirth" name="priBirth"
                   th:value="${#temporals.format(userDetailsDto.userPrivate.priBirth, 'yyyy-MM-dd')}" />
        </div>

        <div class="form-group">
            <label for="mbNickName">닉네임</label>
            <input type="text" id="mbNickName" name="mbNickName"
                   th:value="${userDetailsDto.user.mbNickname}" />
        </div>

        <div class="form-group">
            <label for="mbStatusMessage">상태 메세지</label>
            <input type="text" id="mbStatusMessage" name="mbStatusMessage"
                   th:value="${userDetailsDto.user.mbStatusMessage}" />
        </div>

        <div class="form-group">
            <label for="priGender">성별</label>
            <select id="priGender" name="priGender" required>
                <option value="">선택하세요</option>
                <option value="M" th:selected="${userDetailsDto.userPrivate.priGender == 'M'}">남성</option>
                <option value="F" th:selected="${userDetailsDto.userPrivate.priGender == 'F'}">여성</option>
            </select>
        </div>

        <!-- 숨겨진 필드들 -->
        <input type="hidden" name="mbId" th:value="${userDetailsDto.user.mbId}" />
        <input type="hidden" name="currentProfileUrl" th:value="${userDetailsDto.user.mbProfileUrl}" />

        <button type="submit" class="btn">프로필 업데이트</button>
    </form>
</div>

<script>
    // 파일 선택 시 미리보기 표시
    document.getElementById("files").addEventListener("change", function(e) {
        const file = e.target.files[0];
        const previewContainer = document.getElementById("imagePreview");
        const previewImage = document.getElementById("previewImage");

        if (file) {
            // 파일 크기 체크 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert("파일 크기는 5MB 이하로 업로드해주세요.");
                e.target.value = "";
                previewContainer.style.display = "none";
                return;
            }

            // 이미지 파일 체크
            if (!file.type.startsWith('image/')) {
                alert("이미지 파일만 업로드 가능합니다.");
                e.target.value = "";
                previewContainer.style.display = "none";
                return;
            }

            // 미리보기 표시
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = "block";
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = "none";
        }
    });

    // 폼 제출 처리 - 모든 데이터를 한 번에 처리
    document.getElementById("profile").addEventListener("submit", async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
        const mbId = document.querySelector("input[name='mbId']").value;

        try {
            // multipart/form-data로 모든 데이터를 한 번에 전송
            const formData = new FormData();

            // 사용자 정보를 JSON으로 구성
            const userUpdateData = {
                authUserId: document.getElementById("authUserId").value,
                mbNickName: document.getElementById("mbNickName").value,
                mbStatusMessage: document.getElementById("mbStatusMessage").value,
                priEmail: document.getElementById("priEmail").value,
                priBirth: document.getElementById("priBirth").value,
                priGender: document.getElementById("priGender").value,
                mbProfileUrl: document.querySelector("input[name='currentProfileUrl']").value || ""
            };

            console.log("전송할 데이터:", userUpdateData); // 디버깅용

            // JSON 데이터를 Blob으로 추가
            formData.append('userUpdateDto', new Blob([JSON.stringify(userUpdateData)], {
                type: 'application/json'
            }));

            // 새 파일이 있으면 추가
            const fileInput = document.getElementById("files");
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
                console.log("새 프로필 이미지 포함됨"); // 디버깅용
            }

            // 하나의 API로 모든 업데이트 수행
            const response = await fetch(`/api/v1/user/${mbId}/update-with-image`, {
                method: "PATCH",
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData,
                credentials: "include"
            });

            if (response.ok) {
                alert("회원정보가 성공적으로 수정되었습니다!");
                window.location.href = "/game-hub";
            } else {
                const errorText = await response.text();
                alert("회원정보 수정 실패: " + errorText);
                console.error("응답 오류:", errorText); // 디버깅용
            }

        } catch (error) {
            console.error("요청 오류:", error);
            alert("요청 처리 중 오류가 발생했습니다.");
        }
    });
</script>
</body>
</html>
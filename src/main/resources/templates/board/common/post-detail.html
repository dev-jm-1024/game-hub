<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<h1 id="post-title" th:text="${postsData.getPostTitle()}">게시글 제목</h1>

<div>
    <strong>작성자:</strong>
    <span th:text="${authUserId} ?: '알 수 없음'"></span>
</div>

<div>
    <strong>작성일:</strong>
    <span id="post-date" th:text="${postsData.getCreatedAt}">날짜</span>
</div>

<div>
    <strong>조회수:</strong>
    <span id="post-views" th:text="${postsData.getViewCount}">0</span>
</div>

<div>
    <strong>사진:</strong>
    <img th:src="${postFiles.getFileUrl}" alt="image">
</div>

<hr>

<div>
    <p id="post-content" th:text="${postsData.getPostContent}">게시글 내용</p>
</div>

<hr>

<div id="memberForm" th:if="${isAuthUser}">
    <form id="updatePosts" method="get" action="/board/posts/edit">
        <input type="hidden" name="postId" th:value="${postsData.getPostId}">
        <input type="hidden" name="boardId" th:value="${postsData.getBoard().boardId}">
        <button type="submit">수정하기</button>
    </form>

    <form id="deletePosts">
        <input type="hidden" name="postId" th:value="${postsData.getPostId}">
        <input type="hidden" name="boardId" th:value="${postsData.getBoard().boardId}">
        <button type="submit">삭제하기</button>
    </form>
</div>
<a th:href="@{'/board/' + ${postsData.getBoard().getBoardId} + '/view'}">목록으로 돌아가기</a>

<hr>

<!-- 댓글 입력폼 포함 -->
<div id="comment-section">

    <!-- ✅ 댓글 입력 폼 삽입 (comment-form.html의 form 부분) -->
    <div th:replace="~{fragments/comment-form :: commentFormFragment}"></div>

    <hr>

    <!-- ✅ 댓글 목록 뷰 삽입 (comment-view.html의 리스트 부분) -->
    <div th:replace="~{fragments/comment-view :: commentListFragment}"></div>

</div>

<script>
    document.getElementById('deletePosts').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        const boardId = form.querySelector('input[name="boardId"]').value;
        const postId = form.querySelector('input[name="postId"]').value;

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/api/v1/board/${boardId}/posts/${postId}/deactivate`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [header]: token
            },
            body: params
        })
            .then(response => {
                if (response.ok) {
                    alert("삭제 성공");
                    window.location.href = `/board`;
                } else {
                    alert("삭제 실패");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("에러 발생: " + error);
            });
    });

    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const commentContent = form.querySelector('input[name="commentContent"]').value;
        const postId = form.querySelector('input[name="postId"]').value;
        const boardId = form.querySelector('input[name="boardId"]').value;

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        if (!commentContent || commentContent.trim() === "") {
            alert("댓글 내용을 입력해주세요.");
            return;
        }

        fetch(`/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify({
                commentContent: commentContent,
                postId: postId,
                boardId: boardId  // 서버에서 쓰이지 않더라도 전송 가능
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("댓글 등록 성공!");
                    window.location.reload(); // 새로고침으로 댓글 반영
                } else {
                    return response.text().then(msg => { throw new Error(msg); });
                }
            })
            .catch(error => {
                console.error("댓글 등록 실패:", error);
                alert("댓글 등록 실패: " + error.message);
            });
    });
</script>
</body>
</html>

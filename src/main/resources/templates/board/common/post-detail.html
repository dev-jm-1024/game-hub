<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/board-skin/common-skin/post-skin/css/post-detail.css}">

    <!-- 서버 데이터를 JavaScript에 전달하는 스크립트 (수정된 버전) -->
    <script th:inline="javascript">
        // 전역 변수로 서버 데이터 설정
        window.postDetailData = {
            postId: /*[[${postDetail.posts.postId}]]*/ null,
            reactType: /*[[${postDetail.reactType}]]*/ 'NONE',
            likeCount: /*[[${postDetail.postsReactionCount != null ? postDetail.postsReactionCount.likeCount : 0}]]*/ 0,
            dislikeCount: /*[[${postDetail.postsReactionCount != null ? postDetail.postsReactionCount.dislikeCount : 0}]]*/ 0,
            isLoggedIn: /*[[${postDetail.reactType != null or postDetail.isAuthor != null}]]*/ false,
            isUserReported: /*[[${postDetail.isUserReported != null ? postDetail.isUserReported : false}]]*/ false
        };

        // 댓글 신고 데이터 추가
        window.userCommentReportMap = /*[[${postDetail.userCommentReportMap}]]*/ {};

        console.log('서버 데이터 로드됨:', window.postDetailData);
        console.log('댓글 신고 데이터 로드됨:', window.userCommentReportMap);
    </script>
    <!-- 기존 스타일은 그대로 유지 -->
    <style>
        .like-button, .dislike-button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .like-button:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .like-button.liked {
            background-color: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .dislike-button:hover {
            border-color: #6b6bff;
            color: #6b6bff;
        }

        .dislike-button.disliked {
            background-color: #6b6bff;
            color: white;
            border-color: #6b6bff;
        }

        .like-button:disabled, .dislike-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .post-reactions {
            margin: 20px 0;
            text-align: center;
        }

        .like-count, .dislike-count {
            margin-left: 8px;
            font-weight: bold;
        }

        .login-message {
            text-align: center;
            margin: 20px 0;
            color: #666;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .login-message a {
            color: #007bff;
            text-decoration: none;
        }

        .login-message a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="post-detail-body">

<div class="post-detail-container">
    <div class="post-header">
        <h1 class="post-title" th:text="${postDetail.posts.postTitle}">게시글 제목</h1>

        <div class="post-meta">
            <div class="post-meta-item">
                <strong>작성자:</strong>
                <span th:text="${postDetail.posts.user != null ? postDetail.posts.user.mbNickname : '알 수 없음'}">닉네임</span>
            </div>

            <div class="post-meta-item">
                <strong>작성일:</strong>
                <span th:text="${#temporals.format(postDetail.posts.createdAt, 'yyyy-MM-dd')}">날짜</span>
            </div>

            <div class="post-meta-item">
                <strong>조회수:</strong>
                <span th:text="${postDetail.posts.viewCount}">0</span>
            </div>
        </div>
    </div>

    <div class="post-content-wrapper">
        <div class="post-content">
            <p id="post-content" th:text="${postDetail.posts.postContent}">게시글 내용</p>
        </div>

        <div class="post-attachments" th:if="${postDetail.hasPostFile}">
            <strong>첨부 이미지:</strong>
            <div class="attachment-image" th:each="postFile : ${postDetail.postFilesList}">
                <img th:src="@{${postFile.fileUrl}}" alt="첨부 이미지" class="post-image">
            </div>
        </div>
        <div class="post-attachments" th:unless="${postDetail.hasPostFile}">
            <p class="no-attachments">첨부파일이 없습니다.</p>
        </div>
    </div>

    <!-- 로그인 사용자용 좋아요/싫어요 섹션 -->
    <div class="post-reactions" th:if="${postDetail.reactType != null or postDetail.isAuthor != null}">
        <button id="like-button"
                class="like-button"
                th:classappend="${postDetail.reactType != null and postDetail.reactType.toString() == 'LIKE'} ? 'liked' : ''"
                aria-label="좋아요 버튼">
            <span id="like-icon"
                  th:text="${postDetail.reactType != null and postDetail.reactType.toString() == 'LIKE'} ? '💔' : '❤️'">❤️</span>
            <span id="like-text"
                  th:text="${postDetail.reactType != null and postDetail.reactType.toString() == 'LIKE'} ? '좋아요 취소' : '좋아요'">좋아요</span>
            <span id="like-count" class="like-count"
                  th:text="${postDetail.postsReactionCount != null ? postDetail.postsReactionCount.likeCount : 0}">0</span>
        </button>

        <button id="dislike-button"
                class="dislike-button"
                th:classappend="${postDetail.reactType != null and postDetail.reactType.toString() == 'DISLIKE'} ? 'disliked' : ''"
                aria-label="싫어요 버튼">
            <span id="dislike-icon"
                  th:text="${postDetail.reactType != null and postDetail.reactType.toString() == 'DISLIKE'} ? '👍' : '👎'">👎</span>
            <span id="dislike-text"
                  th:text="${postDetail.reactType != null and postDetail.reactType.toString() == 'DISLIKE'} ? '싫어요 취소' : '싫어요'">싫어요</span>
            <span id="dislike-count" class="dislike-count"
                  th:text="${postDetail.postsReactionCount != null ? postDetail.postsReactionCount.dislikeCount : 0}">0</span>
        </button>
    </div>

    <!-- 비로그인 사용자용 메시지 -->
    <div class="login-message" th:unless="${postDetail.reactType != null or postDetail.isAuthor != null}">
        <p>좋아요/싫어요를 누르려면 <a href="/login">로그인</a>이 필요합니다.</p>
    </div>

    <!-- 전체 반응 통계 -->
    <div class="reaction-stats" th:if="${postDetail.postsReactionCount != null}" style="text-align: center; margin: 10px 0; font-size: 14px; color: #666;">
        총 반응: <span th:text="${postDetail.postsReactionCount.likeCount + postDetail.postsReactionCount.dislikeCount}">0</span>개
        (좋아요 <span th:text="${postDetail.postsReactionCount.likeCount}">0</span>개,
        싫어요 <span th:text="${postDetail.postsReactionCount.dislikeCount}">0</span>개)
    </div>

    <div class="post-actions" id="memberForm" th:if="${postDetail.isAuthor}">
        <form id="updatePosts" method="get" action="/board/posts/edit" class="action-form">
            <input type="hidden" name="postId" th:value="${postDetail.posts.postId}">
            <input type="hidden" name="boardId" th:value="${postDetail.posts.board.boardId}">
            <button type="submit" class="edit-button">수정하기</button>
        </form>

        <form id="deletePosts" class="action-form">
            <input type="hidden" name="postId" th:value="${postDetail.posts.postId}">
            <input type="hidden" name="boardId" th:value="${postDetail.posts.board.boardId}">
            <button type="submit" class="delete-button">삭제하기</button>
        </form>
    </div>

    <div class="navigation-actions">
        <a th:href="@{'/board/' + ${postDetail.posts.board.boardId} + '/view'}" class="back-button">목록으로 돌아가기</a>
    </div>

    <!-- 댓글 입력폼 포함 -->
    <div id="comment-section" class="comment-section">
        <div th:replace="~{board/comment/comment-form :: commentFormFragment}"></div>
        <hr class="comment-separator">
        <div th:replace="~{board/comment/comment-view :: commentListFragment}"></div>
    </div>
</div>

<script th:src="@{/board-skin/common-skin/post-skin/js/post-detail.js}"></script>
<script th:src="@{/board-skin/common-skin/post-skin/js/post-detail-report.js}"></script>
<script th:src="@{/board-skin/comment-skin/js/comment-form.js}"></script>
<script th:src="@{/board-skin/comment-skin/js/comment-report.js}"></script>
</body>
</html>
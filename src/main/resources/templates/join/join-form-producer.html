<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>제작사 회원가입</title>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link rel="stylesheet" th:href="@{/join-skin/css/join-form.css}">
</head>
<body>
<main>
  <h1>제작사 회원가입</h1>
  <form id="joinForm">
    <input type="hidden" name="prod" id="prod" value="producer">

    <!-- 아이디 + 중복확인 버튼 -->
    <div class="form-group inline">
      <div class="input-wrapper">
        <label for="authUserId">아이디</label>
        <input type="text" id="authUserId" name="authUserId" required>
        <span id="idCheckMsg" class="status-message"></span>
      </div>
      <button type="button" id="checkIdBtn" class="btn btn-check">중복 확인</button>
    </div>

    <div class="form-group">
      <label for="authPassword">비밀번호</label>
      <input type="password" id="authPassword" name="authPassword" required>
    </div>

    <div class="form-group">
      <label for="mbNickname">제작사 혹은 팀 이름</label>
      <input type="text" id="mbNickname" name="mbNickname" required>
    </div>

    <!-- 이메일 + 중복확인 버튼 -->
    <div class="form-group inline">
      <div class="input-wrapper">
        <label for="priEmail">이메일</label>
        <input type="email" id="priEmail" name="priEmail" required>
        <span id="emailCheckMsg" class="status-message"></span>
      </div>
      <button type="button" id="checkEmailBtn" class="btn btn-check">중복 확인</button>
    </div>

    <div class="form-group">
      <label for="priBirth">생년월일</label>
      <input type="date" id="priBirth" name="priBirth" required>
    </div>

    <div class="form-group">
      <label for="priGender">대표 성별</label>
      <select id="priGender" name="priGender" required>
        <option value="">선택하세요</option>
        <option value="M">남성</option>
        <option value="F">여성</option>
      </select>
    </div>

    <div class="form-group">
      <label for="mbStatusMessage">소개 메시지</label>
      <input type="text" id="mbStatusMessage" name="mbStatusMessage" placeholder="제작사/팀을 소개해주세요" required>
    </div>

    <div class="form-group">
      <label for="files">로고/프로필 이미지 (선택사항)</label>
      <input type="file" id="files" name="files" accept="image/*" />
      <small>※ 이미지 파일만 업로드 가능 (최대 5MB) • 드래그 앤 드롭으로도 업로드 가능</small>
    </div>

    <div class="button-group">
      <button type="submit" id="joinBtn" class="btn btn-primary" disabled>가입하기</button>
      <button type="button" class="btn btn-secondary" onclick="history.back()">취소</button>
    </div>
  </form>
</main>

<script th:src="@{/join-skin/js/join-form.js}"></script>
<script>
  const userIdInput = document.getElementById("authUserId");
  const checkIdBtn = document.getElementById("checkIdBtn");
  const idCheckMsg = document.getElementById("idCheckMsg");

  const emailInput = document.getElementById("priEmail");
  const checkEmailBtn = document.getElementById("checkEmailBtn");
  const emailCheckMsg = document.getElementById("emailCheckMsg");

  const joinBtn = document.getElementById("joinBtn");

  let isIdValid = false;
  let isEmailValid = false;

  // 가입하기 버튼 활성화 체크
  function checkFormValid() {
    joinBtn.disabled = !(isIdValid && isEmailValid);

    if (isIdValid && isEmailValid) {
      joinBtn.style.background = 'linear-gradient(135deg, #007aff 0%, #0056b3 100%)';
    } else {
      joinBtn.style.background = '';
    }
  }

  // 아이디 중복 확인
  checkIdBtn.addEventListener("click", async function () {
    const userId = userIdInput.value.trim();

    if (!userId) {
      window.FormAnimations?.showStatusMessage(idCheckMsg, "아이디를 입력해주세요.", "warning");
      window.FormAnimations?.showFieldError(userIdInput);
      isIdValid = false;
      checkFormValid();
      return;
    }

    window.FormAnimations?.setButtonLoading(this, true);

    try {
      const response = await fetch(`/api/v1/user/check-id?userId=${encodeURIComponent(userId)}`);

      if (response.ok) {
        window.FormAnimations?.showStatusMessage(idCheckMsg, "사용 가능한 아이디입니다!", "success");
        window.FormAnimations?.showFieldSuccess(userIdInput);
        isIdValid = true;
      } else if (response.status === 406) {
        const message = await response.text();
        window.FormAnimations?.showStatusMessage(idCheckMsg, message || "이미 존재하는 아이디입니다.", "error");
        window.FormAnimations?.showFieldError(userIdInput);
        isIdValid = false;
      } else {
        window.FormAnimations?.showStatusMessage(idCheckMsg, "오류 발생", "warning");
        window.FormAnimations?.showFieldError(userIdInput);
        isIdValid = false;
      }
      checkFormValid();
    } catch (error) {
      console.error(error);
      window.FormAnimations?.showStatusMessage(idCheckMsg, "서버 오류", "warning");
      window.FormAnimations?.showFieldError(userIdInput);
      isIdValid = false;
      checkFormValid();
    } finally {
      window.FormAnimations?.setButtonLoading(this, false);
    }
  });

  // 이메일 중복 확인
  checkEmailBtn.addEventListener("click", async function () {
    const email = emailInput.value.trim();

    if (!email) {
      window.FormAnimations?.showStatusMessage(emailCheckMsg, "이메일을 입력해주세요.", "warning");
      window.FormAnimations?.showFieldError(emailInput);
      isEmailValid = false;
      checkFormValid();
      return;
    }

    window.FormAnimations?.setButtonLoading(this, true);

    try {
      const response = await fetch(`/api/v1/user/check-email?email=${encodeURIComponent(email)}`);

      if (response.ok) {
        window.FormAnimations?.showStatusMessage(emailCheckMsg, "사용 가능한 이메일입니다!", "success");
        window.FormAnimations?.showFieldSuccess(emailInput);
        isEmailValid = true;
      } else if (response.status === 406) {
        const message = await response.text();
        window.FormAnimations?.showStatusMessage(emailCheckMsg, message || "이미 존재하는 이메일입니다.", "error");
        window.FormAnimations?.showFieldError(emailInput);
        isEmailValid = false;
      } else {
        window.FormAnimations?.showStatusMessage(emailCheckMsg, "오류 발생", "warning");
        window.FormAnimations?.showFieldError(emailInput);
        isEmailValid = false;
      }
      checkFormValid();
    } catch (error) {
      console.error(error);
      window.FormAnimations?.showStatusMessage(emailCheckMsg, "서버 오류", "warning");
      window.FormAnimations?.showFieldError(emailInput);
      isEmailValid = false;
      checkFormValid();
    } finally {
      window.FormAnimations?.setButtonLoading(this, false);
    }
  });

  // 아이디 입력 값 변경 시 중복확인 상태 초기화
  userIdInput.addEventListener("input", () => {
    isIdValid = false;
    window.FormAnimations?.hideStatusMessage(idCheckMsg);
    userIdInput.style.borderColor = '';
    userIdInput.style.boxShadow = '';
    checkFormValid();
  });

  // 이메일 입력 값 변경 시 중복확인 상태 초기화
  emailInput.addEventListener("input", () => {
    isEmailValid = false;
    window.FormAnimations?.hideStatusMessage(emailCheckMsg);
    emailInput.style.borderColor = '';
    emailInput.style.boxShadow = '';
    checkFormValid();
  });

  // 제작사 회원가입 처리
  document.getElementById("joinForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    if (!isIdValid) {
      alert("아이디 중복 확인을 먼저 해주세요.");
      return;
    }

    if (!isEmailValid) {
      alert("이메일 중복 확인을 먼저 해주세요.");
      return;
    }

    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

    window.FormAnimations?.setButtonLoading(joinBtn, true);

    try {
      // 항상 multipart/form-data로 전송
      const formData = new FormData();

      // JSON 데이터를 Blob으로 추가 - prod 필드로 제작사 구분
      const userSignupDto = {
        prod: document.getElementById("prod").value, // "producer"
        authUserId: document.getElementById("authUserId").value,
        authPassword: document.getElementById("authPassword").value,
        mbNickname: document.getElementById("mbNickname").value, // 제작사/팀명
        priEmail: document.getElementById("priEmail").value,
        priBirth: document.getElementById("priBirth").value,
        priGender: document.getElementById("priGender").value,
        mbStatusMessage: document.getElementById("mbStatusMessage").value
      };

      formData.append('userSignupDto', new Blob([JSON.stringify(userSignupDto)], {
        type: 'application/json'
      }));

      // 파일이 있으면 추가 (없어도 괜찮음)
      const fileInput = document.getElementById("files");
      if (fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
      }

      const response = await fetch("/api/v1/user", {
        method: "POST",
        headers: {
          [csrfHeader]: csrfToken
        },
        body: formData
      });

      if (response.ok) {
        window.FormAnimations?.showSubmitSuccess();
        setTimeout(() => {
          alert("제작사 회원가입에 성공하였습니다!");
          window.location.href = "/game-hub";
        }, 1000);
      } else {
        const errorText = await response.text();
        alert("회원가입 실패: " + errorText);
      }

    } catch (error) {
      console.error("회원가입 요청 중 오류:", error);
      alert("회원가입 요청 중 오류가 발생했습니다.");
    } finally {
      window.FormAnimations?.setButtonLoading(joinBtn, false);
    }
  });
</script>
</body>
</html>
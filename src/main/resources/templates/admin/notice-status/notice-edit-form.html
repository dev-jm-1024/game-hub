<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>공지사항 수정</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/mtd15zog4k4o1j46iuetihb96c0qr2p4a4hapacz18au7lb5/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <link rel="stylesheet" th:href="@{/admin-skin/css/notice-edit-form.css}">
</head>
<body>
<div class="container-fluid">
    <div class="form-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>공지사항 수정</h2>
            <a href="/admin/board/notice-status" class="btn btn-secondary">목록으로</a>
        </div>

        <!-- 공지사항 수정 폼 -->
        <form id="noticeEditForm" method="POST" enctype="multipart/form-data"
              th:action="@{'/admin/api/v1/notice/' + ${notice.postId} + '/edit'}">
            <!-- CSRF 토큰 (Spring Security) -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- 게시글 ID (hidden) -->
            <input type="hidden" name="postId" th:value="${notice.postId}"/>

            <!-- 제목 -->
            <div class="mb-3">
                <label for="postTitle" class="form-label">제목 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="postTitle" name="postTitle" required
                       th:value="${notice.postTitle}" placeholder="공지사항 제목을 입력하세요">
            </div>

            <!-- 중요도 설정 -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="importantAct" name="importantAct" value="1"
                           th:checked="${notice.importantAct == 1}">
                    <label class="form-check-label" for="importantAct">
                        <span class="badge bg-warning text-dark">중요</span> 중요 공지사항으로 설정
                    </label>
                </div>
            </div>

            <!-- 본문 내용 -->
            <div class="mb-3">
                <label for="postContent" class="form-label">내용 <span class="text-danger">*</span></label>
                <textarea id="postContent" name="postContent" class="form-control" rows="15" required
                          th:text="${notice.postContent}" placeholder="공지사항 내용을 입력하세요..."></textarea>
            </div>

            <!-- 기존 첨부파일 -->
            <div class="mb-3" th:if="${postFiles != null and !#lists.isEmpty(postFiles)}">
                <label class="form-label">기존 첨부파일</label>
                <div class="existing-files">
                    <div th:each="file, fileStat : ${postFiles}" class="existing-file-item">
                        <!-- 기존 파일 URL을 hidden input으로 저장 (유지할 파일들만) -->
                        <input type="hidden" th:name="|oldFileUrl[${fileStat.index}]|" th:value="${file.fileUrl}" class="keep-file-input">

                        <span th:text="${file.fileUrl}">파일경로</span>
                        <button type="button" class="file-delete-btn"
                                th:onclick="|removeOldFile(${fileStat.index}, this)|">×</button>
                    </div>
                </div>
            </div>

            <!-- 새로운 첨부파일 (선택사항) -->
            <div class="mb-3">
                <label for="files" class="form-label">새 첨부파일 추가</label>
                <div class="file-upload-area" onclick="document.getElementById('files').click()">
                    <input type="file" class="file-input" id="files" name="files" multiple
                           accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip">
                    <div class="file-upload-text">
                        <p>파일을 선택하거나 여기로 드래그하세요</p>
                        <p class="text-muted">최대 5개 파일, 파일당 10MB 이하</p>
                    </div>
                </div>
                <div id="filePreview" class="file-preview"></div>
            </div>

            <!-- 버튼 그룹 -->
            <div class="d-flex justify-content-end btn-group">
                <button type="button" class="btn btn-outline-secondary"
                        onclick="location.href='/admin/board/notice-status'">취소</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    수정하기
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // TinyMCE 초기화
    tinymce.init({
        selector: '#postContent',
        height: 400,
        language: 'ko_KR',
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
        ],
        toolbar: 'undo redo | blocks | bold italic forecolor backcolor | ' +
            'alignleft aligncenter alignright alignjustify | ' +
            'bullist numlist outdent indent | removeformat | ' +
            'link image media table | code preview fullscreen | emoticons',
        content_style: `
           body {
               font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
               font-size: 14px;
               line-height: 1.6;
           }
       `,
        automatic_uploads: true,
        file_picker_types: 'image',
        file_picker_callback: function (callback, value, meta) {
            if (meta.filetype === 'image') {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.onchange = function () {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function () {
                        callback(reader.result, {
                            alt: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                };

                input.click();
            }
        },
        setup: function (editor) {
            editor.on('change', function () {
                editor.save();
            });
        }
    });

    // 기존 파일 제거 함수 (DOM에서만 제거, 서버에는 전송되지 않음)
    function removeOldFile(index, buttonElement) {
        if (confirm('이 파일을 제거하시겠습니까?')) {
            const fileItem = buttonElement.closest('.existing-file-item');
            const hiddenInput = fileItem.querySelector('.keep-file-input');

            // hidden input을 비활성화해서 서버로 전송되지 않도록 함
            hiddenInput.disabled = true;

            // 시각적으로 제거된 것처럼 표시
            fileItem.style.opacity = '0.5';
            fileItem.style.textDecoration = 'line-through';
            buttonElement.disabled = true;
            buttonElement.textContent = '제거됨';
        }
    }

    // 파일 업로드 관련 이벤트
    const fileInput = document.getElementById('files');
    const fileUploadArea = document.querySelector('.file-upload-area');
    const filePreview = document.getElementById('filePreview');

    fileInput.addEventListener('change', handleFileSelect);

    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleFileSelect();
    });

    function handleFileSelect() {
        filePreview.innerHTML = '';
        const files = fileInput.files;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = file.name;
            filePreview.appendChild(fileItem);
        }
    }

    // 폼 제출 이벤트
    document.getElementById('noticeEditForm').addEventListener('submit', function(e) {
        e.preventDefault();

        tinymce.triggerSave();

        const title = document.getElementById('postTitle').value.trim();
        const content = tinymce.get('postContent').getContent();

        if (!title) {
            alert('제목을 입력해주세요.');
            return false;
        }

        if (!content || content.trim() === '') {
            alert('내용을 입력해주세요.');
            return false;
        }

        const submitBtn = document.getElementById('submitBtn');
        const spinner = submitBtn.querySelector('.spinner-border');

        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 수정 중...';

        this.submit();
    });

    // 페이지 벗어날 때 경고
    let isFormChanged = false;

    document.getElementById('noticeEditForm').addEventListener('input', function() {
        isFormChanged = true;
    });

    window.addEventListener('beforeunload', function (e) {
        if (isFormChanged) {
            e.preventDefault();
            e.returnValue = '수정 중인 내용이 있습니다. 정말 페이지를 벗어나시겠습니까?';
        }
    });

    document.getElementById('noticeEditForm').addEventListener('submit', function() {
        isFormChanged = false;
    });
</script>
</body>
</html>
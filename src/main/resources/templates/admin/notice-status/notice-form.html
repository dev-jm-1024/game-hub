<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>공지사항 작성</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/mtd15zog4k4o1j46iuetihb96c0qr2p4a4hapacz18au7lb5/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        .form-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .btn-group {
            gap: 10px;
        }
        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .file-upload-area:hover {
            border-color: #007bff;
        }
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .file-input {
            display: none;
        }
        .file-preview {
            margin-top: 10px;
        }
        .file-item {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="form-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>공지사항 작성</h2>
            <a href="/admin/board/notice-status" class="btn btn-secondary">목록으로</a>
        </div>

        <!-- 공지사항 작성 폼 -->
        <form id="noticeForm">
            <!-- CSRF 토큰 (Spring Security) -->
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <input type="hidden" name="_csrf_header" th:value="${_csrf.headerName}"/>

            <!-- 제목 -->
            <div class="mb-3">
                <label for="postTitle" class="form-label">제목 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="postTitle" name="postTitle" required
                       placeholder="공지사항 제목을 입력하세요">
            </div>

            <!-- 중요도 설정 -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="importantAct" name="importantAct" value="1">
                    <label class="form-check-label" for="importantAct">
                        <span class="badge bg-warning text-dark">중요</span> 중요 공지사항으로 설정
                    </label>
                </div>
            </div>

            <!-- 본문 내용 -->
            <div class="mb-3">
                <label for="postContent" class="form-label">내용 <span class="text-danger">*</span></label>
                <textarea id="postContent" name="postContent" class="form-control" rows="15" required
                          placeholder="공지사항 내용을 입력하세요..."></textarea>
            </div>

            <!-- 첨부파일 (선택사항) -->
            <div class="mb-3">
                <label for="files" class="form-label">첨부파일</label>
                <div class="file-upload-area" onclick="document.getElementById('files').click()">
                    <input type="file" class="file-input" id="files" name="files" multiple
                           accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip">
                    <div class="file-upload-text">
                        <p>파일을 선택하거나 여기로 드래그하세요</p>
                        <p class="text-muted">최대 5개 파일, 파일당 10MB 이하</p>
                    </div>
                </div>
                <div id="filePreview" class="file-preview"></div>
            </div>

            <!-- 버튼 그룹 -->
            <div class="d-flex justify-content-end btn-group">
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">초기화</button>
                <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">임시저장</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    게시하기
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // TinyMCE 초기화
    tinymce.init({
        selector: '#postContent',
        height: 400,
        language: 'ko_KR',
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
        ],
        toolbar: 'undo redo | blocks | bold italic forecolor backcolor | ' +
            'alignleft aligncenter alignright alignjustify | ' +
            'bullist numlist outdent indent | removeformat | ' +
            'link image media table | code preview fullscreen | emoticons',
        content_style: `
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    font-size: 14px;
                    line-height: 1.6;
                }
            `,
        // 이미지 업로드 설정 (필요시 서버 연동)
        automatic_uploads: true,
        file_picker_types: 'image',
        file_picker_callback: function (callback, value, meta) {
            if (meta.filetype === 'image') {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.onchange = function () {
                    const file = this.files[0];
                    const reader = new FileReader();
                    reader.onload = function () {
                        callback(reader.result, {
                            alt: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                };

                input.click();
            }
        },
        setup: function (editor) {
            editor.on('change', function () {
                editor.save();
            });
        }
    });

    // 파일 업로드 관련 이벤트
    const fileInput = document.getElementById('files');
    const fileUploadArea = document.querySelector('.file-upload-area');
    const filePreview = document.getElementById('filePreview');

    // 파일 선택 시 미리보기
    fileInput.addEventListener('change', handleFileSelect);

    // 드래그 앤 드롭 이벤트
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleFileSelect();
    });

    function handleFileSelect() {
        filePreview.innerHTML = '';
        const files = fileInput.files;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.textContent = file.name;
            filePreview.appendChild(fileItem);
        }
    }

    // 폼 제출 이벤트
    document.getElementById('noticeForm').addEventListener('submit', function(e) {
        e.preventDefault();

        tinymce.triggerSave();

        // 필수 필드 검증
        const title = document.getElementById('postTitle').value.trim();
        const content = tinymce.get('postContent').getContent();

        if (!title) {
            alert('제목을 입력해주세요.');
            return false;
        }

        if (!content || content.trim() === '') {
            alert('내용을 입력해주세요.');
            return false;
        }

        // 제출 버튼 상태 변경
        const submitBtn = document.getElementById('submitBtn');
        const spinner = submitBtn.querySelector('.spinner-border');

        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 게시 중...';

        // FormData 생성
        const formData = new FormData();

        // JSON 데이터 생성
        const noticeData = {
            postTitle: title,
            postContent: content,
            importantAct: document.getElementById('importantAct').checked ? 1 : 0
        };

        // JSON을 Blob으로 변환하여 추가
        formData.append('data', new Blob([JSON.stringify(noticeData)], {
            type: 'application/json'
        }));

        // 파일이 있으면 추가
        const files = fileInput.files;
        if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
        }

        // CSRF 토큰
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        // API 호출
        fetch('/admin/api/v1/notice/create', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('서버 오류가 발생했습니다.');
            })
            .then(data => {
                alert('공지사항이 성공적으로 등록되었습니다.');
                window.location.href = '/admin/board/notice-status';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('공지사항 등록 중 오류가 발생했습니다.');
            })
            .finally(() => {
                // 버튼 상태 복원
                submitBtn.disabled = false;
                spinner.classList.add('d-none');
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm d-none" role="status"></span> 게시하기';
            });
    });

    // 폼 초기화 함수
    function resetForm() {
        if (confirm('작성 중인 내용이 모두 삭제됩니다. 계속하시겠습니까?')) {
            document.getElementById('noticeForm').reset();
            tinymce.get('postContent').setContent('');
            filePreview.innerHTML = '';
        }
    }

    // 임시저장 함수 (추후 구현)
    function saveDraft() {
        tinymce.triggerSave();
        console.log('임시저장 기능 - 추후 구현 예정');
        alert('임시저장 기능은 추후 구현 예정입니다.');
    }

    // 페이지 벗어날 때 경고
    let isFormChanged = false;

    document.getElementById('noticeForm').addEventListener('input', function() {
        isFormChanged = true;
    });

    window.addEventListener('beforeunload', function (e) {
        if (isFormChanged) {
            e.preventDefault();
            e.returnValue = '작성 중인 내용이 있습니다. 정말 페이지를 벗어나시겠습니까?';
        }
    });

    // 폼 제출 시 경고 해제
    document.getElementById('noticeForm').addEventListener('submit', function() {
        isFormChanged = false;
    });
</script>
</body>
</html>